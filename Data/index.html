<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Title</title>
</head>

<body style="margin: 0; padding: 0;">
    <canvas style="object-fit: contain; min-width: 100%; max-width: 100%; max-height: 100vh; min-height: 100vh; display: block;" id='khanvas' tabindex='-1'></canvas>
    <script>
        const CANVAS = document.getElementById('khanvas');

        let bridgeScript = null;
        let bridgeTimeout = null;
        let bridgeLoaded = false;

        function addLocalBridge() {
            if (bridgeLoaded) return;
            bridgeLoaded = true;
            clearTimeout(bridgeTimeout);

            if (bridgeScript && bridgeScript.parentNode) {
                bridgeScript.onload = null;
                bridgeScript.onerror = null;
                bridgeScript.src = '';
                bridgeScript.parentNode.removeChild(bridgeScript);
            }

            const scriptElement = document.createElement('script');
            scriptElement.src = './playgama-bridge.js';
            document.body.appendChild(scriptElement);
            scriptElement.onload = function() {
                initializeBridge();
            }
        }

        bridgeScript = document.createElement('script');
        bridgeScript.src = 'https://bridge.playgama.com/v1/stable/playgama-bridge.js';
        bridgeScript.onload = initializeBridge;
        bridgeScript.onerror = addLocalBridge;

        bridgeTimeout = setTimeout(function() {
            console.warn('CDN bridge failed to load within 2 seconds, loading local bridge')
            addLocalBridge();
        }, 2000);

        document.head.appendChild(bridgeScript);

        function initializeBridge() {
            clearTimeout(bridgeTimeout);
            bridge.engine = 'js'; // TODO: add 'armory' or 'kha'
            bridge.initialize().then(function(){
                bridge.game.setLoadingProgress(0);
                const khaElement = document.createElement('script');
                khaElement.src = 'kha.js';
                document.body.appendChild(khaElement);
                khaElement.onload = function() {
                    bridge.game.setLoadingProgress(100);
                    console.log("Kha initialized.");
                }
            })
        }
    </script>
</body>
</html>
